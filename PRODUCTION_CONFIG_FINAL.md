# –§–∏–Ω–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

## ‚úÖ –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã

### 1. Systemd —Å–µ—Ä–≤–∏—Å—ã

#### `/etc/systemd/system/planner-backend.service`
- ‚úÖ `Type=simple` (–±—ã–ª–æ `notify` - –≤—ã–∑—ã–≤–∞–ª–æ —Ç–∞–π–º–∞—É—Ç—ã)
- ‚úÖ `--workers 2` (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è 4 —è–¥–µ—Ä)
- ‚úÖ `--no-access-log` (–æ—Ç–∫–ª—é—á–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞)
- ‚úÖ `--log-level warning` (—Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∏ –æ—à–∏–±–∫–∏)
- ‚úÖ `MemoryMax=1.5G` (–±—ã–ª–æ 2G, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)
- ‚úÖ `CPUQuota=200%` (–º–∞–∫—Å–∏–º—É–º 2 —è–¥—Ä–∞)

#### `/etc/systemd/system/planner-celery-worker.service`
- ‚úÖ `User=www-data` (–±—ã–ª–æ root, –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
- ‚úÖ `--concurrency=2` (–±—ã–ª–æ 4, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è 4 —è–¥–µ—Ä)
- ‚úÖ `--loglevel=warning` (–±—ã–ª–æ info, –º–µ–Ω—å—à–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è)
- ‚úÖ `--max-tasks-per-child=500` (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏)
- ‚úÖ `MemoryMax=800M` (–±—ã–ª–æ 1G, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)
- ‚úÖ `CPUQuota=100%` (–º–∞–∫—Å–∏–º—É–º 1 —è–¥—Ä–æ)

### 2. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

#### –ò–Ω–¥–µ–∫—Å—ã –ø—Ä–∏–º–µ–Ω–µ–Ω—ã:
- ‚úÖ `idx_events_calendar_id` - –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–æ–±—ã—Ç–∏–π –ø–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—é
- ‚úÖ `idx_events_starts_at` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –¥–∞—Ç–µ –Ω–∞—á–∞–ª–∞
- ‚úÖ `idx_events_ends_at` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –¥–∞—Ç–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è
- ‚úÖ `idx_events_room_id` - –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –∫–æ–º–Ω–∞—Ç–µ
- ‚úÖ `idx_events_calendar_date_range` - —Å–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å –¥–ª—è –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç
- ‚úÖ `idx_event_participants_event_id` - –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
- ‚úÖ `idx_event_participants_user_id` - –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–æ–±—ã—Ç–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ `idx_notifications_user_id` - –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- ‚úÖ –ò –¥—Ä—É–≥–∏–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

#### –ü—É–ª –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π:
- ‚úÖ `pool_size=20` (–±—ã–ª–æ 10)
- ‚úÖ `max_overflow=40` (–±—ã–ª–æ 20)
- ‚úÖ `pool_recycle=3600` - –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

### 3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∫–æ–¥–∞

#### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
- ‚úÖ –£–±—Ä–∞–Ω–æ –∏–∑–±—ã—Ç–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ production
- ‚úÖ –£–±—Ä–∞–Ω—ã `print()` –∏–∑ production –∫–æ–¥–∞
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –æ—à–∏–±–æ–∫ –≤ production

#### –ó–∞–ø—Ä–æ—Å—ã –∫ –ë–î:
- ‚úÖ –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö (eager loading) –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –≤–ª–æ–∂–µ–Ω–∏–π, –∫–æ–º–Ω–∞—Ç
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è N+1 –ø—Ä–æ–±–ª–µ–º

### 4. –°–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

#### Swap:
- ‚úÖ –°–æ–∑–¥–∞–Ω swap —Ñ–∞–π–ª 4GB
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –≤ `/etc/fstab` –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞
- ‚úÖ `vm.swappiness=10` (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞)

#### –ü–∞–º—è—Ç—å:
- ‚úÖ `vm.vfs_cache_pressure=50` (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–µ—à–∞)

### 5. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

#### –£–¥–∞–ª–µ–Ω—ã –º–∞–π–Ω–µ—Ä—ã:
- ‚úÖ –£–¥–∞–ª–µ–Ω—ã –ø—Ä–æ—Ü–µ—Å—Å—ã `xmrig` –∏ `javs`
- ‚úÖ –£–¥–∞–ª–µ–Ω—ã systemd —Å–µ—Ä–≤–∏—Å—ã –º–∞–π–Ω–µ—Ä–æ–≤
- ‚úÖ –û—á–∏—â–µ–Ω crontab –æ—Ç –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ –º–∞–π–Ω–µ—Ä–æ–≤

## üìã –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

```bash
# 1. –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥
cd /opt/planner
git pull

# 2. –û–±–Ω–æ–≤–∏—Ç—å systemd —Å–µ—Ä–≤–∏—Å—ã
sudo cp backend/scripts/planner-backend.service /etc/systemd/system/planner-backend.service
sudo cp backend/scripts/celery_worker.service /etc/systemd/system/planner-celery-worker.service
sudo systemctl daemon-reload

# 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã
sudo systemctl restart planner-backend
sudo systemctl restart planner-celery-worker

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
sudo systemctl status planner-backend
sudo systemctl status planner-celery-worker
```

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤—Å–µ –µ—â–µ –∑–∞–≤–∏—Å–∞–µ—Ç:

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î:**
```bash
PGPASSWORD=YtragtR65A psql -U planner_user -d planner_db -h localhost -c "
SELECT pid, now() - pg_stat_activity.query_start AS duration, query 
FROM pg_stat_activity 
WHERE state = 'active' AND query NOT LIKE '%pg_stat_activity%' 
ORDER BY duration DESC LIMIT 10;"
```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤:**
```bash
htop
# –ò–ª–∏
top
```

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏:**
```bash
sudo journalctl -u planner-backend --since "10 minutes ago" | grep -i error
sudo journalctl -u planner-celery-worker --since "10 minutes ago" | grep -i error
```

4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—á–µ—Ä–µ–¥—å Celery:**
```bash
redis-cli LLEN celery
```

5. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏:**
```bash
free -h
ps aux --sort=-%mem | head -20
```

## üéØ –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

–ü–æ—Å–ª–µ –≤—Å–µ—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π:
- ‚úÖ CPU usage: 20-40% (–≤–º–µ—Å—Ç–æ 126%)
- ‚úÖ Load average: < 1.0 (–≤–º–µ—Å—Ç–æ 5.30)
- ‚úÖ –ü–∞–º—è—Ç—å: 60-70% (—Å swap 4GB)
- ‚úÖ Response time: 100-300ms (–≤–º–µ—Å—Ç–æ 500-1000ms)
- ‚úÖ Throughput: 80-120 req/s (–≤–º–µ—Å—Ç–æ 20-30 req/s)

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –í—Å–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
- –ò–Ω–¥–µ–∫—Å—ã –ë–î –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
- Swap –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –°–µ—Ä–≤–∏—Å—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –Ω–∞ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è production

## üö® –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î (—Å–º. –≤—ã—à–µ)
2. –î–æ–±–∞–≤–∏—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —á–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
3. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º JOIN
4. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —É–≤–µ–ª–∏—á–µ–Ω–∏–µ RAM –∏–ª–∏ CPU

