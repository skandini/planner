# Документация компонентов корпоративного календаря

## Обзор архитектуры

Проект использует Next.js 16 с TypeScript и Tailwind CSS. После рефакторинга монолитный файл `page.tsx` (4387 строк) был разбит на модульную структуру с четким разделением ответственности.

## Структура проекта

```
frontend/src/
├── app/
│   └── page.tsx                    # Главный компонент приложения (~1600 строк)
├── components/                      # UI компоненты
│   ├── calendar/                    # Компоненты календаря
│   ├── events/                      # Компоненты событий
│   ├── participants/                 # Компоненты участников
│   ├── rooms/                       # Компоненты переговорных
│   ├── availability/                 # Компоненты доступности
│   └── notifications/                # Компоненты уведомлений
├── hooks/                           # Кастомные React хуки
├── lib/
│   ├── api/                         # API клиенты
│   ├── constants.ts                 # Константы приложения
│   └── utils/                       # Утилиты
└── types/                           # TypeScript типы
```

---

## Компоненты календаря (`components/calendar/`)

### WeekView

**Назначение**: Отображение календаря в виде недели с временными слотами.

**Основные функции**:
- Отображение событий на временной шкале (часы/минуты)
- Перетаскивание событий (drag & drop)
- Клик по временным слотам для создания новых событий
- Навигация по неделям
- Визуализация конфликтов и пересечений

**Props**:
- `days: Date[]` - массив дней недели
- `selectedDate: Date` - выбранная дата
- `events: EventRecord[]` - список событий
- `onEventClick: (event: EventRecord) => void` - обработчик клика по событию
- `onEventMove?: (eventId: string, newStart: Date, newEnd: Date) => void` - обработчик перемещения
- `onTimeSlotClick?: (date: Date, startTime: Date, endTime: Date) => void` - обработчик клика по слоту

**Особенности**:
- Поддержка событий на весь день
- Визуализация занятых/свободных слотов
- Адаптивная сетка с временными метками

---

### MonthView

**Назначение**: Отображение календаря в виде месяца с сеткой дней.

**Основные функции**:
- Отображение календарной сетки месяца
- Показ событий в днях
- Навигация по месяцам
- Выделение текущей даты
- Клик по дню для перехода к недельному виду

**Props**:
- `days: Date[]` - массив дней месяца
- `selectedDate: Date` - выбранная дата
- `onSelectDate: (date: Date) => void` - обработчик выбора даты
- `events: EventRecord[]` - список событий
- `onEventClick: (event: EventRecord) => void` - обработчик клика по событию

**Особенности**:
- Автоматическое вычисление дней месяца с учетом предыдущего/следующего месяца
- Группировка событий по дням
- Визуализация событий с учетом их длительности

---

## Компоненты событий (`components/events/`)

### EventModal

**Назначение**: Модальное окно для создания и редактирования событий.

**Основные функции**:
- Создание новых событий
- Редактирование существующих событий
- Настройка рекуррентности (повторения)
- Управление участниками
- Бронирование переговорных
- Проверка конфликтов расписания
- Удаление событий и серий

**Props**:
- `form: EventDraft` - данные формы события
- `setForm: (form: EventDraft | ((prev: EventDraft) => EventDraft)) => void` - обновление формы
- `onSubmit: (event: FormEvent<HTMLFormElement>) => void` - обработчик отправки
- `onDelete?: () => void` - обработчик удаления
- `onDeleteSeries?: () => void` - обработчик удаления серии
- `isEditing: boolean` - режим редактирования
- `canManageEvents: boolean` - права на управление событиями
- `rooms: Room[]` - список переговорных
- `members: CalendarMember[]` - участники календаря
- `users: UserProfile[]` - список пользователей
- `recurrenceInfo?: {...}` - информация о рекуррентности
- `editingEvent?: EventRecord` - редактируемое событие

**Особенности**:
- Интеграция с ResourcePanel для управления ресурсами
- Автоматическая загрузка доступности переговорных
- Проверка конфликтов в реальном времени
- Поддержка режима "только чтение" для пользователей без прав редактирования
- Управление статусами участников

---

### MoveSeriesDialog

**Назначение**: Диалог выбора области действия при перемещении рекуррентного события.

**Основные функции**:
- Выбор между перемещением одного события или всей серии
- Отображение старого и нового времени события
- Подтверждение перемещения

**Props**:
- `context: PendingMoveContext` - контекст перемещения (старое/новое время)
- `scope: "single" | "series"` - область действия
- `onScopeChange: (next: "single" | "series") => void` - изменение области
- `onSubmit: () => void` - подтверждение перемещения
- `isSubmitting: boolean` - состояние отправки

**Особенности**:
- Визуальное сравнение времени до и после перемещения
- Предупреждение о последствиях выбора

---

## Компоненты участников (`components/participants/`)

### ParticipantsSection

**Назначение**: Секция управления участниками события.

**Основные функции**:
- Добавление участников в событие
- Поиск пользователей
- Отображение списка участников
- Управление правами доступа

**Props**:
- `form: EventDraft` - форма события
- `setForm: (form: EventDraft | ((prev: EventDraft) => EventDraft)) => void` - обновление формы
- `users: UserProfile[]` - список пользователей
- `usersLoading: boolean` - состояние загрузки
- `usersError: string | null` - ошибка загрузки
- `members: CalendarMember[]` - участники календаря
- `selectedCalendarId: string | null` - ID выбранного календаря
- `authFetch: AuthenticatedFetch` - функция авторизованных запросов
- `onRefreshMembers: () => Promise<void> | void` - обновление списка участников

**Особенности**:
- Автодополнение при поиске пользователей
- Фильтрация уже добавленных участников
- Интеграция с UnifiedAvailabilityTimeline для просмотра доступности

---

### ParticipantStatusItem

**Назначение**: Элемент отображения статуса участника события.

**Основные функции**:
- Отображение информации об участнике
- Показ статуса ответа (принял/отклонил/возможно)
- Изменение статуса участника (для администраторов)

**Props**:
- `participant: EventParticipant` - данные участника
- `eventId: string` - ID события
- `onUpdateStatus?: (eventId: string, userId: string, status: string) => Promise<void>` - обновление статуса
- `canManage: boolean` - права на управление

**Особенности**:
- Визуальная индикация статуса (цвет, иконки)
- Поддержка различных статусов: `accepted`, `declined`, `tentative`

---

## Компоненты переговорных (`components/rooms/`)

### ResourcePanel

**Назначение**: Панель управления переговорными и участниками события.

**Основные функции**:
- Выбор переговорной для события
- Просмотр доступности переговорной
- Добавление участников
- Просмотр конфликтов расписания
- Интеграция с ParticipantsSection

**Props**:
- `rooms: Room[]` - список переговорных
- `form: EventDraft` - форма события
- `setForm: (form: EventDraft | ((prev: EventDraft) => EventDraft)) => void` - обновление формы
- `selectedRoom: Room | null` - выбранная переговорная
- `roomAvailability: EventRecord[]` - доступность переговорной
- `conflicts: ConflictEntry[]` - конфликты расписания
- `members: CalendarMember[]` - участники календаря
- `users: UserProfile[]` - список пользователей
- `authFetch: AuthenticatedFetch` - функция авторизованных запросов

**Особенности**:
- Автоматическая загрузка доступности при выборе переговорной
- Визуализация занятых слотов
- Отображение конфликтов с участниками

---

## Компоненты доступности (`components/availability/`)

### UnifiedAvailabilityTimeline

**Назначение**: Объединенная временная шкала доступности участников и переговорных.

**Основные функции**:
- Отображение доступности нескольких участников одновременно
- Визуализация свободных/занятых слотов
- Группировка по участникам
- Подсветка оптимального времени

**Props**:
- `participants: ParticipantProfile[]` - профили участников
- `rooms: Room[]` - переговорные
- `selectedDate: Date` - выбранная дата
- `timeSlots: {...}[]` - временные слоты
- `onParticipantClick?: (userId: string) => void` - клик по участнику

**Особенности**:
- Агрегация данных от нескольких источников
- Цветовая индикация доступности
- Адаптивная сетка

---

### ConflictSummary

**Назначение**: Сводка конфликтов расписания.

**Основные функции**:
- Отображение списка конфликтов
- Группировка по типам конфликтов
- Подсчет количества конфликтов

**Props**:
- `conflicts: ConflictEntry[]` - список конфликтов
- `loading: boolean` - состояние загрузки
- `error: string | null` - ошибка

**Особенности**:
- Категоризация конфликтов (участники, переговорные)
- Визуальная индикация серьезности

---

### UserAvailabilityView

**Назначение**: Детальный просмотр доступности конкретного пользователя.

**Основные функции**:
- Отображение временной шкалы доступности пользователя
- Показ событий пользователя на выбранную дату
- Добавление пользователя в календарь (если не является участником)

**Props**:
- `userId: string` - ID пользователя
- `user: UserProfile | null` - профиль пользователя
- `availability: EventRecord[]` - доступность (события)
- `loading: boolean` - состояние загрузки
- `error: string | null` - ошибка
- `selectedDate: Date` - выбранная дата
- `isMember: boolean` - является ли участником календаря
- `onAddToCalendar: () => void` - добавление в календарь

**Особенности**:
- Детальная временная сетка (15-минутные слоты)
- Список событий пользователя
- Интеграция с календарем

---

## Компоненты уведомлений (`components/notifications/`)

### NotificationCenter

**Назначение**: Центр уведомлений приложения.

**Основные функции**:
- Отображение списка уведомлений
- Отметка уведомлений как прочитанных
- Массовая отметка всех как прочитанных
- Удаление уведомлений
- Переход к связанным событиям

**Props**:
- `notifications: Notification[]` - список уведомлений
- `loading: boolean` - состояние загрузки
- `unreadCount: number` - количество непрочитанных
- `onMarkAsRead: (notificationId: string) => Promise<void>` - отметка как прочитанного
- `onMarkAllAsRead: () => Promise<void>` - отметка всех как прочитанных
- `onDelete: (notificationId: string) => Promise<void>` - удаление
- `onEventClick: (eventId: string) => void` - переход к событию

**Особенности**:
- Категоризация по типам (приглашения, обновления, отмены, напоминания)
- Цветовая индикация типов
- Форматирование времени (относительное и абсолютное)
- Индикация непрочитанных уведомлений

---

## Кастомные хуки (`hooks/`)

### useEvents

**Назначение**: Управление состоянием и операциями со событиями.

**Функции**:
- Загрузка событий календаря
- Создание новых событий
- Обновление событий
- Удаление событий
- Перемещение событий
- Обновление статуса участника

**Возвращает**:
- `events: EventRecord[]` - список событий
- `loading: boolean` - состояние загрузки
- `error: string | null` - ошибка
- `createEvent: (event: EventDraft) => Promise<void>` - создание события
- `updateEvent: (id: string, event: Partial<EventDraft>) => Promise<void>` - обновление
- `deleteEvent: (id: string) => Promise<void>` - удаление
- `moveEvent: (id: string, newStart: Date, newEnd: Date) => Promise<void>` - перемещение

---

### useCalendars

**Назначение**: Управление календарями пользователя.

**Функции**:
- Загрузка списка календарей
- Создание календарей
- Удаление календарей
- Управление участниками календаря
- Получение конфликтов
- Получение доступности участника

**Возвращает**:
- `calendars: Calendar[]` - список календарей
- `loading: boolean` - состояние загрузки
- `error: string | null` - ошибка
- `createCalendar: (calendar: CalendarDraft) => Promise<void>` - создание
- `deleteCalendar: (id: string) => Promise<void>` - удаление
- `getMembers: (calendarId: string) => Promise<CalendarMember[]>` - участники
- `addMember: (calendarId: string, userId: string, role: CalendarRole) => Promise<void>` - добавление участника

---

### useNotifications

**Назначение**: Управление уведомлениями.

**Функции**:
- Загрузка списка уведомлений
- Получение количества непрочитанных
- Отметка как прочитанного
- Массовая отметка всех как прочитанных
- Удаление уведомлений

**Возвращает**:
- `notifications: Notification[]` - список уведомлений
- `unreadCount: number` - количество непрочитанных
- `loading: boolean` - состояние загрузки
- `error: string | null` - ошибка
- `markAsRead: (id: string) => Promise<void>` - отметка как прочитанного
- `markAllAsRead: () => Promise<void>` - отметка всех
- `deleteNotification: (id: string) => Promise<void>` - удаление

---

### useUsers

**Назначение**: Поиск и управление пользователями.

**Функции**:
- Поиск пользователей по запросу
- Debounce для оптимизации запросов

**Возвращает**:
- `users: UserProfile[]` - список пользователей
- `loading: boolean` - состояние загрузки
- `error: string | null` - ошибка
- `searchUsers: (query: string) => Promise<void>` - поиск

---

### useRooms

**Назначение**: Управление переговорными.

**Функции**:
- Загрузка списка переговорных
- Получение доступности переговорной

**Возвращает**:
- `rooms: Room[]` - список переговорных
- `loading: boolean` - состояние загрузки
- `error: string | null` - ошибка
- `getAvailability: (roomId: string, date: Date) => Promise<EventRecord[]>` - доступность

---

## API клиенты (`lib/api/`)

### baseApi.ts

**Назначение**: Базовый модуль для авторизованных API запросов.

**Экспорты**:
- `AuthenticatedFetch` - тип функции авторизованного fetch
- `useAuthenticatedFetch()` - хук для получения функции с автоматическим обновлением токенов

**Особенности**:
- Автоматическое добавление JWT токена
- Автоматическое обновление токена при истечении
- Перенаправление на логин при ошибке авторизации

---

### calendarApi.ts

**Назначение**: API клиент для работы с календарями.

**Функции**:
- `list()` - список календарей
- `create(calendar: CalendarDraft)` - создание
- `delete(id: string)` - удаление
- `getMembers(calendarId: string)` - участники
- `addMember(calendarId: string, userId: string, role: CalendarRole)` - добавление участника
- `getConflicts(calendarId: string, from: Date, to: Date)` - конфликты
- `getUserAvailability(calendarId: string, userId: string, from: Date, to: Date)` - доступность пользователя

---

### eventApi.ts

**Назначение**: API клиент для работы с событиями.

**Функции**:
- `list(calendarId: string, from: Date, to: Date)` - список событий
- `create(calendarId: string, event: EventDraft)` - создание
- `update(id: string, payload: Partial<EventDraft>)` - обновление
- `move(id: string, newStart: Date, newEnd: Date)` - перемещение
- `delete(id: string)` - удаление
- `updateParticipantStatus(eventId: string, userId: string, status: string)` - обновление статуса участника

---

### notificationApi.ts

**Назначение**: API клиент для работы с уведомлениями.

**Функции**:
- `list()` - список уведомлений
- `getUnreadCount()` - количество непрочитанных
- `markAsRead(id: string)` - отметка как прочитанного
- `markAllAsRead()` - отметка всех как прочитанных
- `delete(id: string)` - удаление

---

### roomApi.ts

**Назначение**: API клиент для работы с переговорными.

**Функции**:
- `list()` - список переговорных
- `getAvailability(roomId: string, date: Date)` - доступность переговорной

---

### userApi.ts

**Назначение**: API клиент для работы с пользователями.

**Функции**:
- `list(query: string)` - поиск пользователей

---

## Утилиты (`lib/utils/`)

### dateUtils.ts

**Назначение**: Утилиты для работы с датами и временем.

**Функции**:
- `startOfWeek(date: Date)` - начало недели
- `addDays(date: Date, days: number)` - добавление дней
- `startOfMonth(date: Date)` - начало месяца
- `addMonths(date: Date, months: number)` - добавление месяцев
- `getMonthGridDays(date: Date)` - дни месяца для сетки
- `formatDate(date: Date, options?: {...})` - форматирование даты
- `parseUTC(utcString: string)` - парсинг UTC строки
- `inputToDate(input: string)` - конвертация input в Date
- `toLocalString(date: Date)` - конвертация в локальную строку
- `toUTCString(date: Date)` - конвертация в UTC строку
- `toUTCDateISO(date: Date)` - конвертация в UTC ISO строку

---

## Константы (`lib/constants.ts`)

**Назначение**: Централизованное хранение констант приложения.

**Содержит**:
- API endpoints (`API_BASE_URL`, `CALENDAR_ENDPOINT`, `EVENT_ENDPOINT`, и т.д.)
- Временные константы (`MINUTES_IN_DAY`, `WORKDAY_START_HOUR`, `WORKDAY_END_HOUR`, `SLOT_DURATION_MINUTES`)
- UI метки (`WEEKDAY_LABELS`, `ROLE_LABELS`)
- Значения по умолчанию (`DEFAULT_FORM_STATE`, `DEFAULT_EVENT_FORM`)

---

## Типы (`types/`)

### calendar.types.ts

Типы для календарей:
- `Calendar` - календарь
- `CalendarMember` - участник календаря
- `CalendarDraft` - черновик календаря
- `CalendarRole` - роль в календаре (`owner` | `editor` | `viewer`)

---

### event.types.ts

Типы для событий:
- `EventRecord` - запись события
- `EventDraft` - черновик события
- `ConflictEvent` - событие с конфликтом
- `ConflictEntry` - запись конфликта

---

### user.types.ts

Типы для пользователей:
- `UserProfile` - профиль пользователя
- `EventParticipant` - участник события
- `ParticipantProfile` - профиль участника

---

### room.types.ts

Типы для переговорных:
- `Room` - переговорная

---

### notification.types.ts

Типы для уведомлений:
- `Notification` - уведомление

---

### common.types.ts

Общие типы:
- `ViewMode` - режим отображения (`week` | `month`)
- `TimelineRowData` - данные строки временной шкалы
- `PendingMoveContext` - контекст перемещения события
- `RecurrenceRule` - правило рекуррентности

---

## Главный компонент (`app/page.tsx`)

**Назначение**: Главный компонент приложения, координирующий работу всех подкомпонентов.

**Основные функции**:
- Управление состоянием приложения
- Координация между компонентами
- Обработка пользовательских действий
- Интеграция с API через хуки
- Управление модальными окнами и диалогами

**Основные состояния**:
- Выбранный календарь
- Режим отображения (неделя/месяц)
- Текущая дата
- Открытые модальные окна
- Форма события
- Контекст перемещения

**Основные обработчики**:
- `openEventModal()` - открытие модального окна события
- `handleEventMove()` - обработка перемещения события
- `handleEventSubmit()` - обработка создания/обновления события
- `handleEventDelete()` - обработка удаления события
- `handleMoveSeries()` - обработка перемещения серии

---

## Взаимодействие компонентов

```
page.tsx (главный компонент)
├── WeekView / MonthView (отображение календаря)
│   └── Клик по событию → EventModal
│   └── Перетаскивание → MoveSeriesDialog → API
│   └── Клик по слоту → EventModal
├── EventModal (модальное окно события)
│   ├── ResourcePanel (переговорные и участники)
│   │   ├── ParticipantsSection (управление участниками)
│   │   └── UnifiedAvailabilityTimeline (доступность)
│   │       └── ConflictSummary (конфликты)
│   └── ParticipantStatusItem (статусы участников)
├── NotificationCenter (центр уведомлений)
│   └── Клик по событию → EventModal
└── UserAvailabilityView (доступность пользователя)
    └── Добавление в календарь → API
```

---

## Принципы проектирования

1. **Разделение ответственности**: Каждый компонент отвечает за одну задачу
2. **Переиспользование**: Компоненты независимы и могут использоваться в разных контекстах
3. **Типизация**: Строгая типизация TypeScript для безопасности типов
4. **Централизация**: API клиенты и утилиты в отдельных модулях
5. **Хуки для логики**: Бизнес-логика вынесена в кастомные хуки
6. **Константы**: Все магические числа и строки вынесены в константы

---

## Дальнейшие улучшения

1. **Code Splitting**: Ленивая загрузка компонентов с `React.lazy`
2. **Мемоизация**: Оптимизация рендеринга с `React.memo` и `useMemo`
3. **Error Boundaries**: Обработка ошибок на уровне компонентов
4. **Тестирование**: Unit и интеграционные тесты для компонентов
5. **Accessibility**: Улучшение доступности для screen readers
6. **Мобильная адаптация**: Оптимизация для мобильных устройств

---

## Версия документации

**Дата создания**: 2024  
**Последнее обновление**: После рефакторинга монолитного `page.tsx`  
**Версия проекта**: После разделения на модульную структуру


