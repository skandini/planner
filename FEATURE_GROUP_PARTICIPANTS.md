# 🎯 Групповые участники и права на игнорирование занятости

## 📋 Обзор функционала

Реализация двух взаимосвязанных функций:
1. **Групповые участники** - добавление отделов/организаций как единого участника
2. **Права на override** - возможность игнорировать проверку занятости

---

## 🏗️ Архитектурное решение

### 1. Модель данных

#### Новая таблица `event_group_participants`

```sql
CREATE TABLE event_group_participants (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    event_id UUID NOT NULL REFERENCES events(id) ON DELETE CASCADE,
    group_type VARCHAR(20) NOT NULL, -- 'department' или 'organization'
    group_id UUID NOT NULL,
    added_by UUID NOT NULL REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    
    CONSTRAINT unique_event_group UNIQUE(event_id, group_type, group_id)
);

CREATE INDEX idx_event_group_participants_event_id ON event_group_participants(event_id);
CREATE INDEX idx_event_group_participants_group ON event_group_participants(group_type, group_id);
```

#### Расширение таблицы `users`

```sql
ALTER TABLE users ADD COLUMN can_override_availability BOOLEAN DEFAULT FALSE NOT NULL;
```

---

## 🔄 Логика работы

### При создании события:

```
1. Проверка прав создателя:
   ├─ Если can_override_availability = TRUE
   │  └─ Пропустить проверку занятости для ВСЕХ участников
   │
   └─ Если can_override_availability = FALSE
      ├─ Проверить занятость индивидуальных участников
      └─ НЕ проверять занятость групповых участников

2. Сохранение участников:
   ├─ Индивидуальные → таблица event_participants
   └─ Групповые → таблица event_group_participants

3. Отправка уведомлений:
   ├─ Индивидуальным участникам → напрямую
   └─ Групповым участникам:
      ├─ Найти всех пользователей в группе
      └─ Отправить каждому уведомление
```

### Пример кода (Backend):

```python
# В api/v1/events.py
async def create_event(...):
    # 1. Проверка прав
    creator = await get_user(user_id)
    skip_availability_check = creator.can_override_availability
    
    # 2. Проверка занятости (если нужно)
    if not skip_availability_check:
        for participant_id in form.participant_ids:
            if await is_user_busy(participant_id, start, end):
                raise HTTPException(409, "Участник занят")
    
    # 3. Создание события
    event = await create_event_record(...)
    
    # 4. Добавление участников
    # Индивидуальные
    for participant_id in form.participant_ids:
        await add_participant(event.id, participant_id)
    
    # Групповые
    for group in form.group_participants:
        await add_group_participant(
            event.id, 
            group.type,  # 'department' or 'organization'
            group.id
        )
    
    # 5. Отправка уведомлений
    await notify_participants(event.id)
    await notify_group_participants(event.id)
```

---

## 🎨 UI/UX изменения

### 1. Окно создания события - выбор участников

**Текущее состояние:**
```
┌─────────────────────────────────────┐
│ [Участники] [Отделы] [Организации] │ ← Вкладки
├─────────────────────────────────────┤
│ [Поиск...]                          │
│                                     │
│ ☐ Иванов Иван (Разработчик)       │
│ ☐ Петров Петр (Менеджер)           │
└─────────────────────────────────────┘
```

**Новое состояние:**
```
┌─────────────────────────────────────────────────┐
│ [Участники] [Отделы▼] [Организации▼]          │
├─────────────────────────────────────────────────┤
│ Участники (индивидуально):                     │
│ • Иванов Иван [x]                              │
│ • Петров Петр [x]                              │
│                                                 │
│ Группы (весь отдел/организация):               │
│ • 👥 Отдел: ИТ (12 человек) [x]               │
│ • 🏛️ ООО "КОРСТОУН" (45 человек) [x]          │
│                                                 │
│ ⚠️ Группы: уведомления всем, без проверки     │
│    занятости                                    │
└─────────────────────────────────────────────────┘
```

### 2. Админ-панель - управление правами

```
┌─────────────────────────────────────────────────┐
│ Пользователь: Иванов Иван                      │
│                                                 │
│ Права доступа:                                  │
│ ☑ Доступ к оргструктуре                        │
│ ☑ Доступ к тикетам                             │
│ ☐ Доступ к слотам доступности                  │
│                                                 │
│ Специальные права:                              │
│ ☑ Игнорировать занятость при создании событий │
│   └─ Может назначать встречи в любое время,    │
│      даже если участники заняты                │
│                                                 │
│ [Сохранить изменения]                           │
└─────────────────────────────────────────────────┘
```

### 3. Отображение события - список участников

```
┌─────────────────────────────────────────────────┐
│ Встреча: Новогодний корпоратив                 │
│                                                 │
│ 👤 Индивидуальные участники (3):               │
│ • Иванов Иван (Генеральный директор)          │
│ • Петров Петр (Коммерческий директор)         │
│ • Сидоров Сидор (Финансовый директор)         │
│                                                 │
│ 👥 Группы (2):                                 │
│ • Отдел: ИТ (12 сотрудников)                   │
│   [Развернуть список ▼]                        │
│                                                 │
│ • ООО "КОРСТОУН" (45 сотрудников)             │
│   [Развернуть список ▼]                        │
└─────────────────────────────────────────────────┘
```

---

## 📝 Пошаговая реализация

### Этап 1: Backend - База данных ✅
- [x] Создать модель `EventGroupParticipant`
- [x] Создать схемы Pydantic
- [x] Добавить `can_override_availability` в модель `User`
- [x] Обновить схемы `User`
- [ ] Создать миграцию Alembic

### Этап 2: Backend - API
- [ ] Обновить `POST /events/` для поддержки групповых участников
- [ ] Добавить `GET /events/{id}/group-participants`
- [ ] Добавить логику проверки `can_override_availability`
- [ ] Обновить функцию отправки уведомлений

### Этап 3: Frontend - UI
- [ ] Обновить `ParticipantSearch` для групповых участников
- [ ] Добавить визуальное отличие группы vs индивидуал
- [ ] Показать предупреждение о группах
- [ ] Раскрывающийся список участников группы

### Этап 4: Frontend - Админ-панель
- [ ] Добавить чекбокс "Игнорировать занятость" в управление пользователями
- [ ] Обновить API calls для обновления прав

### Этап 5: Тестирование
- [ ] Создание события с группой
- [ ] Проверка уведомлений всем участникам группы
- [ ] Проверка прав override
- [ ] Проверка UI/UX

---

## ⚠️ Важные моменты

### Безопасность
- Право `can_override_availability` может назначать только **admin** или **IT**
- Логировать все действия с override правами
- Показывать в событии, кто создал (если использовал override)

### Производительность
- При большом количестве участников в группе (например, вся компания):
  - Использовать Celery task для отправки уведомлений
  - Batch-обработка уведомлений

### UX
- Явно показывать что группа = ВСЕ участники
- Предупреждение перед добавлением большой группы
- Возможность раскрыть список участников группы

---

## 🚀 Миграция

```bash
# 1. Создать миграцию
cd backend
alembic revision --autogenerate -m "add_group_participants_and_override_rights"

# 2. Проверить миграцию
alembic upgrade head --sql

# 3. Применить миграцию
alembic upgrade head

# 4. Назначить права админам
psql -d planner -c "UPDATE users SET can_override_availability = TRUE WHERE role = 'admin' OR role = 'it';"
```

---

## 📊 Примеры использования

### Сценарий 1: Новогодний корпоратив
```
Создатель: CEO (есть права override)
Участники: 
  - Индивидуально: Директора (3 человека)
  - Группа: Вся компания (ООО "КОРСТОУН", 45 человек)

Результат:
✅ Событие создано без проверки занятости
✅ Уведомления отправлены всем 48 участникам
✅ В календаре у всех появилось событие
```

### Сценарий 2: Планерка IT-отдела
```
Создатель: IT руководитель (есть права override)
Участники:
  - Группа: Отдел ИТ (12 человек)

Результат:
✅ Событие создано без проверки занятости
✅ Уведомления всем 12 сотрудникам ИТ
✅ Не нужно искать каждого по отдельности
```

### Сценарий 3: Обычная встреча
```
Создатель: Менеджер (НЕТ прав override)
Участники:
  - Индивидуально: 3 коллеги

Результат:
⚠️ Проверка занятости каждого участника
❌ Если кто-то занят - ошибка "Участник недоступен"
✅ Если все свободны - событие создано
```

---

## 🎯 Следующие шаги

1. **Сейчас**: Создать миграцию БД
2. **Далее**: Обновить API endpoints
3. **Затем**: Обновить UI компоненты
4. **Тестирование**: Проверить все сценарии
5. **Деплой**: Развернуть на продакшн

**Готов продолжить реализацию?** 🚀



