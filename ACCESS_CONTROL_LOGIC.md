# Логика контроля доступа

## Принципы работы

### 1. Личные календари
- Каждый пользователь имеет свой личный календарь (создается автоматически при регистрации)
- Пользователь является владельцем (`owner`) своего личного календаря
- Пользователь видит только свои личные календари в списке календарей

### 2. Создание событий
- События можно создавать только в своем личном календаре
- При создании события можно приглашать любых участников (без проверки доступа к календарю)
- Участники не должны быть членами календаря для приглашения

### 3. Просмотр событий
Пользователь видит:
- Все события из своих личных календарей
- Все события, где он является участником (через `EventParticipant`)

### 4. Редактирование событий
- Только владелец календаря может редактировать события в своем календаре
- При редактировании можно добавлять/удалять участников без проверки доступа к календарю

### 5. Удаление событий
- Только владелец календаря может удалять события в своем календаре

### 6. Обновление статуса участника
- Участник может обновлять только свой собственный статус
- Не требуется доступ к календарю - достаточно быть участником события

### 7. Проверка занятости
- Любой пользователь может проверить занятость любого другого пользователя
- Занятость включает:
  - События, где пользователь является участником (через `EventParticipant`)
  - События из личных календарей пользователя (где он владелец)
- Это дает единую занятость независимо от календаря

### 8. Проверка конфликтов
При создании/обновлении события проверяются конфликты:
- **Комнаты**: Комната не должна быть занята другим событием в то же время (в рамках календаря)
- **Участники**: Участники не должны быть заняты в других событиях в то же время
  - Проверяются события, где участник является участником
  - Проверяются события из личных календарей участника

## API Endpoints

### События

#### `POST /api/v1/events`
- **Доступ**: Только владелец календаря может создавать события в своем календаре
- **Участники**: Можно приглашать любых участников без проверки доступа к календарю

#### `GET /api/v1/events`
- **Доступ**: Показывает события из личных календарей пользователя и события, где он участник
- **Фильтр по календарю**: Если указан `calendar_id`, проверяется, что календарь принадлежит пользователю

#### `GET /api/v1/events/{event_id}`
- **Доступ**: Владелец календаря или участник события

#### `PUT /api/v1/events/{event_id}`
- **Доступ**: Только владелец календаря
- **Участники**: Можно добавлять/удалять участников без проверки доступа к календарю

#### `DELETE /api/v1/events/{event_id}`
- **Доступ**: Только владелец календаря

#### `PATCH /api/v1/events/{event_id}/participants/{user_id}/status`
- **Доступ**: Только сам участник может обновлять свой статус
- **Требования**: Пользователь должен быть участником события

### Календари

#### `GET /api/v1/calendars`
- **Доступ**: Показывает только личные календари пользователя

#### `GET /api/v1/calendars/{calendar_id}/members/{user_id}/availability`
- **Доступ**: Любой пользователь может проверить занятость любого другого пользователя
- **Требования**: Календарь должен существовать (но не обязательно принадлежать пользователю)

## Примеры использования

### Пример 1: Пользователь A приглашает пользователя B на событие
1. Пользователь A создает событие в своем личном календаре
2. При создании указывает `participant_ids: [B.id]`
3. Система проверяет занятость пользователя B (все его события)
4. Если нет конфликтов, событие создается, и пользователь B получает уведомление
5. Пользователь B видит событие в своем списке событий (как участник)
6. Пользователь B может обновить свой статус (принял/отклонил)

### Пример 2: Пользователь B приглашает пользователя A на событие
1. Пользователь B создает событие в своем личном календаре
2. При создании указывает `participant_ids: [A.id]`
3. Система проверяет занятость пользователя A (все его события)
4. Если нет конфликтов, событие создается, и пользователь A получает уведомление
5. Пользователь A видит событие в своем списке событий (как участник)
6. Пользователь A может обновить свой статус (принял/отклонил)

### Пример 3: Проверка занятости
1. Пользователь A хочет пригласить пользователя B на встречу
2. Пользователь A вызывает `GET /api/v1/calendars/{calendar_id}/members/{B.id}/availability?from=...&to=...`
3. Система возвращает все события пользователя B в указанном диапазоне:
   - События, где B является участником
   - События из личных календарей B
4. Пользователь A видит занятость пользователя B и может выбрать свободное время

## Важные замечания

1. **Нет необходимости в членстве календаря**: Участники событий не должны быть членами календаря для приглашения
2. **Единая занятость**: Занятость пользователя единая для всех календарей - учитываются все события, где он участвует или которые создал
3. **Взаимное приглашение**: Пользователи могут приглашать друг друга на события в своих личных календарях
4. **Проверка конфликтов**: При создании/обновлении события проверяются конфликты для всех участников, включая события из их личных календарей

